---
title: Small æ’ä»¶åŒ–ä½¿ç”¨(3)å¤šä¸ªé¡µé¢è·³è½¬
date: 2017-01-10 18:39:57
categories: Android
tags: [Small,æ’ä»¶åŒ–,Androidè¿›é˜¶]
---

## å‡†å¤‡é¡µé¢
åˆ›å»ºä¸€ä¸ªæ–°çš„æ’ä»¶ `detail` æ¨¡å—

![jpg](http://ofi52yvuh.bkt.clouddn.com/20170110148402855518215.jpg?imageView2/0/format/jpg)

**æ·»åŠ åˆ°`bundle.json`ä¸­**

```json
{
  "version": "1.0.0",
  "bundles": [
    {
      "uri": "main",
      "pkg": "com.yunfei.gank.app.main"
    },
    {
      "uri": "lib.network",
      "pkg": "com.yunfei.gank.lib.network"
    },
    {
      "uri": "lib.style",
      "pkg": "com.yunfei.gank.lib.style"
    },
    {
      "uri": "detail",
      "pkg": "com.yunfei.gank.app.detail"
    }
  ]
}
```
å¯¹äº†ï¼Œåˆ›å»ºå®Œè®°å¾—åˆ é™¤ `values` æ–‡ä»¶å¤¹ä¸­çš„ `styles` `colors` ï¼Œä¾èµ–ä¸Š`lib.style`æ¨¡å—ç»Ÿä¸€ä¸€ä¸‹ä¸»é¢˜

å†åˆ›å»ºä¸€ä¸ªå­é¡µé¢ `SubDetailActivity`
![jpg](http://ofi52yvuh.bkt.clouddn.com/20170110148402993069218.jpg?imageView2/0/format/jpg)
## è·³è½¬

å¥½äº†ï¼Œå‡†å¤‡å·¥ä½œå®Œæˆäº†ğŸ˜‹
ä½¿ç”¨å“ªä¸ªæ–¹æ³•è·³è½¬å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆçœ‹`å®¿ä¸»App`çš„ä»£ç  `Small.openUri("main", LaunchActivity.this)` è¿™ä¸ªæ–¹æ³•å¯ä»¥è·³è½¬åˆ°`main`æ¨¡å—
æˆ‘ä»¬ç‚¹å‡» `main` æ¨¡å—åˆ—è¡¨ï¼Œè·³è½¬åˆ° `DetailActivity`ï¼Œæ·»åŠ ä»£ç `Small.openUri("detail", v.getContext());` è¿è¡ŒæˆåŠŸæ‰“å¼€

é‚£æˆ‘ä»¬æƒ³è·³è½¬åˆ°`SubDetail`å‘¢ï¼Ÿ`Small.openUri("subdetail", LaunchActivity.this)`,æˆ‘è¿™ä¹ˆè¯•äº†ä¸€ä¸‹ï¼Œç¡®å®æ˜¯ä¸è¡Œï¼Œçœ‹ä¸‹è¿™ä¸ªå…ˆ[https://github.com/wequick/Small/wiki/UI-route](https://github.com/wequick/Small/wiki/UI-route)

çœ‹ä¸‹å®˜æ–¹ä¾‹å­

```json
{
  "version": "1.0.0",
  "bundles": [
    {
      "uri": "home",
      "pkg": ".bundle.home",
      "rules": {
        "page1": ".MyPage1",
        "page2": ".MyPage2"
      }
    }
  ]
}
```
åªçœ‹ `Android` äº† 
`Small.openUri("home", context); // Turn to *.bundle.home.MainActivity (1)`
`Small.openUri("home/page1", context); // Turn to *.bundle.home.MyPage1Activity (1)`

æˆ‘ä»¬æ”¹ä¸‹ä»£ç è¿è¡Œ

```json
{
  "version": "1.0.0",
  "bundles": [
    {
      "uri": "main",
      "pkg": "com.yunfei.gank.app.main"
    },
    {
      "uri": "lib.network",
      "pkg": "com.yunfei.gank.lib.network"
    },
    {
      "uri": "lib.style",
      "pkg": "com.yunfei.gank.lib.style"
    },
    {
      "uri": "detail",
      "pkg": "com.yunfei.gank.app.detail",
      "rules": {
        "subdetail": ".SubDetail"
      }
    }
  ]
}
```
è·³è½¬ä¿®æ”¹è¿‡ä¸º

```Java
Small.openUri("detail/subdetail", v.getContext());
```

æˆåŠŸäº†ğŸ˜‹ ï¼ŒåŸç†åˆ†æåè¾¹åˆ†æ
## å‚æ•°ä¼ é€’

ä»¥å‰æˆ‘ä»¬éƒ½æ˜¯åˆ›å»ºä¸€ä¸ª`Intent`è°ƒç”¨ `intent.putExtras(key,value);`ç»™ä¸‹ä¸€ä¸ªé¡µé¢ä¼ é€’å‚æ•°ï¼ŒSmallå‘¢ï¼Œæ˜¯å¦ä¹Ÿæœ‰`Intent`æ–¹å¼å‘¢ æˆ‘ä»¬å†çœ‹ [https://github.com/wequick/Small/wiki/UI-route](https://github.com/wequick/Small/wiki/UI-route)

æˆ‘ä»¬æŒ‰å®˜æ–¹ä¿®æ”¹ä»£ç 
```Java
Small.openUri("detail/subdetail?from=app.home", v.getContext());
```

```Java
// app.detail/SubDetailActivity
Uri uri = Small.getUri(this);
if (uri != null) {
  String from = uri.getQueryParameter("from");
  Toast.makeText(this, from, Toast.LENGTH_SHORT).show();
}
```
æˆåŠŸäº†ğŸ˜‹ 
ä½†æ˜¯æˆ‘è¿˜æƒ³ç»§ç»­ä½¿ç”¨ `Intent` ä¼ é€’å‚æ•°å¯ä»¥ä¹ˆï¼Ÿæˆ‘æ‰¾åˆ°äº†ä¸‹é¢çš„æ–¹æ³•
`public static Intent getIntentOfUri(String uriString, Context context)`

ä¿®æ”¹ä»£ç 

```Java 
//app.main
Intent intent = Small.getIntentOfUri("detail/subdetail", v.getContext());
intent.putExtra("from","from app of intent");
v.getContext().startActivity(intent);
```

```Java 
//app.detail/SubDetailActivity
Intent intent = getIntent();
if (intent != null){
  String from = getIntent().getStringExtra("from");
  Toast.makeText(this, from, Toast.LENGTH_SHORT).show();
}
```
æˆåŠŸäº†ğŸ˜‹ 

## æ”¹è¿›
æˆ‘å†™åˆ°è¿™é‡Œæˆ‘æå‡ºä¸€ç‚¹æ”¹è¿›ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸åº”è¯¥åœ¨æ¯ä¸ª `Activity` ä¸­ç›´æ¥å†™ `"detail/subdetail"`è¿™ç§å­—ç¬¦ä¸²ï¼Œä¸ºäº†é‡ç”¨å’Œé¿å…æ‹¼å†™é”™è¯¯ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ª `Rules` å·¥å…·ï¼Œå¥½æˆ‘ä»¬æ·»åŠ ä¸€ä¸ª `Utils` æ¨¡å—
![jpg](http://ofi52yvuh.bkt.clouddn.com/20170110148404419688904.jpg?imageView2/0/format/jpg)
è®°å¾— **æ·»åŠ åˆ°`bundle.json`** æ–‡ä»¶ä¸­ ä¸ç„¶ä¼šæŠ¥ ==NoClassDefFoundError== 


æˆ‘è¿™é‡Œå†™äº†ä¸€ä¸ª ç»Ÿä¸€ `Activity` è·³è½¬çš„ç±» `RouterUtil` å¼€å‘äººå‘˜å¯ä»¥å…±åŒç»´æŠ¤è¿™ä¸ªç±»ï¼Œå…·ä½“ä»£ç çœ‹ä¸‹[github](https://github.com/MaYunFei/SmallDemo)å…¶ä»–æ’ä»¶ä¾èµ–ä¸€ä¸‹

[GitHub ä»£ç åœ°å€](https://github.com/MaYunFei/SmallDemo)

## åˆ†æ 
å¥½äº†æˆ‘ä»¬è·Ÿä¸€ä¸‹ä»£ç ï¼Œçœ‹çœ‹åˆ°åº•æ€ä¹ˆæ‰èƒ½æ‰¾åˆ°å¯¹åº”çš„ `Activity` (è¿™é‡Œå¯ä»¥ä¸çœ‹)

```Java
// éƒ½æ˜¯é™æ€æ–¹æ³•æœ‰æœ¨æœ‰ éƒ½åœ¨ package net.wequick.small.Bundle.java
public static boolean openUri(String uriString, Context context) {
    //è°ƒç”¨ openUri
   return openUri(makeUri(uriString), context);
}

public static boolean openUri(Uri uri, Context context) {
   // ...çœç•¥...
   // ä¸»è¦çœ‹ Bundle.getLaunchableBundle ä»£ç 
   Bundle bundle = Bundle.getLaunchableBundle(uri);
   if (bundle != null) {
       bundle.launchFrom(context);
       return true;
   }
   return false;
}
//
protected static Bundle getLaunchableBundle(Uri uri) {
   if (sPreloadBundles != null) {
       for (Bundle bundle : sPreloadBundles) {
            //ä¸»è¦çœ‹è¿™ä¸ªbundle.matchesRule
           if (bundle.matchesRule(uri)) {
               if (bundle.mApplicableLauncher == null) {
                   break;
               }

               if (!bundle.enabled) return null; // Illegal bundle (invalid signature, etc.)
               return bundle;
           }
       }
   }
    //çœç•¥
   return null;
}
```
éå†çš„ `sPreloadBundles` è¿™ä¸ªå‚æ•°åœ¨å“ªé‡Œèµ‹å€¼çš„ï¼Ÿ

```Java
private static void loadBundles(List<Bundle> bundles) {
   sPreloadBundles = bundles;

   // çœç•¥ä¸€å¤§å †
}

// æ‰¾åˆ°è¿™ä¸ªæ–¹æ³•çš„æœ€å è°ƒç”¨äº†loadBundlesï¼Œè¿™ä¸ªæ–¹æ³•åšä»€ä¹ˆçš„å‘¢ï¼Ÿ å°±æ˜¯ä¸‹è¾¹è¿™ä¸ªæ–¹æ³•è°ƒç”¨äº†
private static void loadBundles(Context context) {
   JSONObject manifestData;
   try {
       File patchManifestFile = getPatchManifestFile();
       String manifestJson = getCacheManifest();
       if (manifestJson != null) {
           // Load from cache and save as patch
           if (!patchManifestFile.exists()) patchManifestFile.createNewFile();
           PrintWriter pw = new PrintWriter(new FileOutputStream(patchManifestFile));
           pw.print(manifestJson);
           pw.flush();
           pw.close();
           // Clear cache
           setCacheManifest(null);
       } else if (patchManifestFile.exists()) {
           // Load from patch
           BufferedReader br = new BufferedReader(new FileReader(patchManifestFile));
           StringBuilder sb = new StringBuilder();
           String line;
           while ((line = br.readLine()) != null) {
               sb.append(line);
           }

           br.close();
           manifestJson = sb.toString();
       } else {
            //è¿™é‡Œæ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿ
           // Load from built-in `assets/bundle.json'
           InputStream builtinManifestStream = context.getAssets().open(BUNDLE_MANIFEST_NAME);
           int builtinSize = builtinManifestStream.available();
           byte[] buffer = new byte[builtinSize];
           builtinManifestStream.read(buffer);
           builtinManifestStream.close();
           manifestJson = new String(buffer, 0, builtinSize);
       }
          //éƒ½æ˜¯å¯¹ manifestJson çš„æ“ä½œ
       // Parse manifest file
       manifestData = new JSONObject(manifestJson);
   } catch (Exception e) {
       e.printStackTrace();
       return;
   }
    //é‡ç‚¹æ˜¯è¿™ä¸ªæ–¹æ³• **parseManifest**
   Manifest manifest = parseManifest(manifestData);
   if (manifest == null) return;

   setupLaunchers(context);

   loadBundles(manifest.bundles);
}

private static Manifest parseManifest(JSONObject data) {
   try {
    //static final String VERSION_KEY = "version";
       String version = data.getString(VERSION_KEY);
       return parseManifest(version, data);
   } catch (JSONException e) {
       e.printStackTrace();
       return null;
   }
}


private static Manifest parseManifest(String version, JSONObject data) {
   if (version.equals("1.0.0")) {
       try {
           JSONArray bundleDescs = data.getJSONArray(BUNDLES_KEY);
           int N = bundleDescs.length();
           List<Bundle> bundles = new ArrayList<Bundle>(N);
           //éå†æ¯ä¸ª bundles
           for (int i = 0; i < N; i++) {
               try {
                   JSONObject object = bundleDescs.getJSONObject(i);
                   //è¿™æ˜¯é‡ç‚¹ 
                   Bundle bundle = new Bundle(object);
                   bundles.add(bundle);
               } catch (JSONException e) {
                   // Ignored
               }
           }
           Manifest manifest = new Manifest();
           manifest.version = version;
           manifest.bundles = bundles;
           return manifest;
       } catch (JSONException e) {
           e.printStackTrace();
           return null;
       }
   }

   throw new UnsupportedOperationException("Unknown version " + version);
}

//ä¸»è¦çœ‹ new Bundle(object) è¿™ä¸ªæ–¹æ³•
public Bundle(JSONObject map) {
   try {
       this.initWithMap(map);
   } catch (JSONException e) {
       e.printStackTrace();
   }
}
//ç»ˆäºåˆ°é‡ç‚¹æ–¹æ³•äº†
private void initWithMap(JSONObject map) throws JSONException {
   if (sUserBundlesPath == null) { // Lazy init
       sUserBundlesPath = Small.getContext().getApplicationInfo().nativeLibraryDir;
       sIs64bit = sUserBundlesPath.contains("64");
   }

   if (map.has("pkg")) {
       String pkg = map.getString("pkg");
       if (pkg != null && !pkg.equals(HOST_PACKAGE)) {
           mPackageName = pkg;
           if (Small.isLoadFromAssets()) {
               mBuiltinAssetName = pkg + ".apk";
               mBuiltinFile = new File(FileUtils.getInternalBundlePath(), mBuiltinAssetName);
               mPatchFile = new File(FileUtils.getDownloadBundlePath(), mBuiltinAssetName);
               // Extract from assets to files
               try {
                   extractBundle(mBuiltinAssetName, mBuiltinFile);
               } catch (IOException e) {
                   e.printStackTrace();
               }
           } else {
               String soName = "lib" + pkg.replaceAll("\\.", "_") + ".so";
               mBuiltinFile = new File(sUserBundlesPath, soName);
               mPatchFile = new File(FileUtils.getDownloadBundlePath(), soName);
           }
       }
   }

   if (map.has("uri")) {
       String uri = map.getString("uri");
       if (!uri.startsWith("http") && Small.getBaseUri() != null) {
           uri = Small.getBaseUri() + uri;
       }
       this.uriString = uri;
       this.uri = Uri.parse(uriString);
   }

   if (map.has("type")) {
       this.type = map.getString("type");
   }

   this.rules = new HashMap<String, String>();
   // Default rules to visit entrance page of bundle
   this.rules.put("", "");
   this.rules.put(".html", "");
   this.rules.put("/index", "");
   this.rules.put("/index.html", "");
   //å°† rules çš„æ˜ å°„åŠ å…¥åˆ° rules
   if (map.has("rules")) {
       // User rules to visit other page of bundle
       JSONObject rulesObj = map.getJSONObject("rules");
       Iterator<String> it = rulesObj.keys();
       while (it.hasNext()) {
           String key = it.next();
           this.rules.put("/" + key, rulesObj.getString(key));
       }
   }
}
```

[GitHub ä»£ç åœ°å€](https://github.com/MaYunFei/SmallDemo)
